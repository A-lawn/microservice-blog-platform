server:
  port: 8080

spring:
  application:
    name: gateway
  
  profiles:
    active: dev
  
  config:
    import:
      - optional:file:../../config/common-nacos.yml
      - optional:file:../../config/common-monitoring.yml
      - optional:file:../../config/common-redis.yml
  
  cloud:
    nacos:
      server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
      config:
        import-check:
          enabled: false
      discovery:
        enabled: true
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:blog-platform}
    
    gateway:
      discovery:
        locator:
          enabled: true
      
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**,/api/notifications/**
          filters:
            - name: CircuitBreaker
              args:
                name: user-service-cb
                fallbackUri: forward:/fallback/user
        
        - id: article-service
          uri: lb://article-service
          predicates:
            - Path=/api/articles/**,/api/categories/**,/api/tags/**
          filters:
            - name: CircuitBreaker
              args:
                name: article-service-cb
                fallbackUri: forward:/fallback/article
        
        - id: comment-service
          uri: lb://comment-service
          predicates:
            - Path=/api/comments/**
          filters:
            - name: CircuitBreaker
              args:
                name: comment-service-cb
                fallbackUri: forward:/fallback/comment
      
      default-filters:
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
            methods: GET,POST
            backoff:
              firstBackoff: 50ms
              maxBackoff: 500ms
              factor: 2
              basedOnPreviousValue: false
      
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

jwt:
  secret: ${JWT_SECRET:mySecretKey123456789012345678901234567890}
  expiration: ${JWT_EXPIRATION:86400}

resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        slidingWindowType: COUNT_BASED
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        minimumNumberOfCalls: 5
        automaticTransitionFromOpenToHalfOpenEnabled: true
    instances:
      user-service-cb:
        baseConfig: default
        waitDurationInOpenState: 30s
      article-service-cb:
        baseConfig: default
        waitDurationInOpenState: 30s
      comment-service-cb:
        baseConfig: default
        waitDurationInOpenState: 30s
  
  timelimiter:
    configs:
      default:
        timeoutDuration: 5s
    instances:
      user-service-cb:
        timeoutDuration: 5s
      article-service-cb:
        timeoutDuration: 10s
      comment-service-cb:
        timeoutDuration: 8s

logging:
  level:
    com.blog.platform.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.loadbalancer: DEBUG
    com.alibaba.nacos: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%logger{50}] - %msg%n"

---
spring:
  config:
    activate:
      on-profile: docker

logging:
  level:
    com.blog.platform.gateway: INFO
    org.springframework.cloud.gateway: INFO
